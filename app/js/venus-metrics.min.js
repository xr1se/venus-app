var Venus=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=4)}([function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.MetricService=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.deviceInterface=t,this.metrics={},this.bindings=[]}return i(e,[{key:"start",value:function(){var e=this;this.deviceInterface.onUpdate=function(t,n){var i=e.metrics[t];void 0!==i&&(i.rawValue=n,void 0!==e.onUpdate&&e.onUpdate(i))},this.deviceInterface.onRawUpdate=function(t,n){void 0!==e.onRawUpdate&&e.onRawUpdate(t,n)},this.deviceInterface.connect()}},{key:"stop",value:function(){this.deviceInterface.disconnect()}},{key:"register",value:function(e,t,n,i,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"r",o=new Venus.Metric(e,n,i,r);return this.metrics[e]=o,void 0!==t&&this.deviceInterface.register(e,t,a),o}},{key:"unregister",value:function(e){this.metrics[e]=void 0,this.deviceInterface.unregister(e)}},{key:"bind",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"innerHTML",n=arguments[2],i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:"value",r=this.metrics[n];if(void 0===r)throw"Binding failed. No registered metric "+n+" was found.";this.bindings.push(new Venus.DataBinding(e,t,r,i))}},{key:"unbind",value:function(e,t,n,i){this.bindings=this.bindings.filter(function(r){return r.element!==e||r.elementProperty!==t||r.metric.key!==n||r.metricProperty!==i})}},{key:"bindElements",value:function(e){for(var t=0;t<e.childNodes.length;t++){var n=e.childNodes[t];if(void 0!==n.attributes){var i=n.attributes["data-metric"],r=n.attributes["data-metric-property"],a=n.attributes["data-binding"],o="innerHTML";void 0!==a&&(o=a.nodeValue);var u="value";if(void 0!==r&&(u=r.nodeValue),void 0!==i){var s=this.metrics[i.nodeValue];void 0!==s?this.bindings.push(new Venus.DataBinding(n,o,s,u)):console.warn("Binding element failed. No registered metric "+i.nodeValue+" was found.")}}this.bindElements(n)}}},{key:"read",value:function(e){this.deviceInterface.read(e)}},{key:"write",value:function(e,t){this.deviceInterface.write(e,t)}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}t.MqttInterface=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"localhost",n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:9001;r(this,e),this.host=t,this.port=n,this.registeredPaths={}}return i(e,[{key:"register",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"r";t.startsWith("/")||(t="/"+t);var i=n.toLowerCase();if("r"!==i&&"w"!==i&&"rw"!==i)throw"Unallowed access "+n;this.registeredPaths[t]=new a(t,e,n)}},{key:"unregister",value:function(e){var t=this.lookupKey(e);void 0!==t&&(this.registeredPaths[t.value]=void 0)}},{key:"lookupKey",value:function(e){for(var t in this.registeredPaths){var n=this.registeredPaths[t];if(void 0!==n&&n.key===e)return n}}},{key:"lookupPath",value:function(e){return this.registeredPaths[e]}},{key:"connect",value:function(){if(void 0!==this.client)throw"The mqtt interface is already connected";this.portalId=void 0,this.clientId=(new Date).toJSON().substring(2,22),this.client=new Paho.MQTT.Client(this.host,this.port,this.clientId);var e=this;this.client.onMessageArrived=function(t){try{var n=t.destinationName;if(void 0===e.portalId){if(n.startsWith("N/")&&n.endsWith("/system/0/Serial")){var i=JSON.parse(t.payloadString);for(var r in e.portalId=i.value,e.registeredPaths)e.client.send("R/"+e.portalId+r,"");e.keepAlive()}}else{var a=e.portalId.length+2;if(n.length>a){var o=n.substring(a),u=e.lookupPath(o),s=JSON.parse(t.payloadString);void 0!==e.onUpdate&&void 0!==u&&u.isReadable&&void 0!==s.value&&e.onUpdate(u.key,s.value),void 0!==e.onRawUpdate&&e.onRawUpdate(o,s.value)}}}catch(t){void 0!==e.onError&&e.onError(t)}},this.client.connect({onSuccess:function(t,n){e.client.subscribe("N/#")}})}},{key:"disconnect",value:function(){void 0!==this.client&&(this.client.disconnect(),this.portalId=void 0,this.client.end())}},{key:"read",value:function(e){if(void 0===this.portalId)throw"Read failed. The mqtt interface has not detected its portal id yet";var t=this.lookupKey(e);if(void 0===t)throw"Read failed. There is no path registered for key: "+e;if(!t.isReadable)throw"Read failed. The path with key "+e+" is not readable";this.client.send("R/"+this.portalId+t.value,"")}},{key:"write",value:function(e,t){if(void 0===this.portalId)throw"Write failed. The mqtt interface has not detected its portal id yet";var n=this.lookupKey(e);if(void 0===n)throw"Write failed. There is no path registered for key: "+e;if(!n.isWritable)throw"Write failed. The path with key "+e+" is not writable";var i=JSON.stringify({value:t});this.client.send("W/"+this.portalId+n.value,i)}},{key:"keepAlive",value:function(){void 0!==this.portalId&&this.client.send("R/"+this.portalId+"/system/0/Serial","")}}]),e}();var a=t.MqttInterfacePath=function e(t,n,i){r(this,e),this.value=t,this.key=n,this.isReadable=i.toLowerCase().includes("r"),this.isWritable=i.toLowerCase().includes("w")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.DataBinding=function(){function e(t,n,i,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.element=t,this.elementProperty=n,this.metric=i,this.metricProperty=r,this.update();var a=this;this.metric.addOnChangeCallback(function(e){a.update()})}return i(e,[{key:"update",value:function(){this.element[this.elementProperty]=this.metric[this.metricProperty]}}]),e}()},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,n,i){return n&&e(t.prototype,n),i&&e(t,i),t}}();t.defaultFormatter=r,t.numericFormatter=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:"--";return function(i){if(void 0===i.rawValue||null===i.rawValue)return n;var r=Number(i.rawValue)*t;return void 0===e?r.toString():r.toFixed(e)}};t.Metric=function(){function e(t,n,i,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.key=t,this.description=n,this.unit=i,this.formatter=void 0===a?r():a,this._rawValue=void 0,this.callbacks=[]}return i(e,[{key:"addOnChangeCallback",value:function(e){this.callbacks.push(e)}},{key:"value",get:function(){return this.formatter(this)}},{key:"rawValue",get:function(){return this._rawValue},set:function(e){var t=this;this._rawValue=e,this.callbacks.forEach(function(e){e(t)})}}]),e}();function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"--";return function(t){return void 0===t.rawValue||null===t.rawValue?e:t.rawValue.toString()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(3);Object.keys(i).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return i[e]}})});var r=n(2);Object.keys(r).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return r[e]}})});var a=n(1);Object.keys(a).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return a[e]}})});var o=n(0);Object.keys(o).forEach(function(e){"default"!==e&&"__esModule"!==e&&Object.defineProperty(t,e,{enumerable:!0,get:function(){return o[e]}})});n(3),u(n(2)),u(n(1)),u(n(0));function u(e){return e&&e.__esModule?e:{default:e}}}]);
//# sourceMappingURL=venus-metrics.min.js.map